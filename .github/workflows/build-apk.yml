name: Build Android APK

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
  workflow_dispatch:  # Permite executar manualmente

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Instalar depend√™ncias
      working-directory: ./frontend
      run: |
        npm ci
        # Verificar se Capacitor foi instalado
        if [ ! -d "node_modules/@capacitor" ]; then
          echo "‚ùå Capacitor n√£o foi instalado"
          exit 1
        fi
    
    - name: Build do projeto
      working-directory: ./frontend
      run: npm run build
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Verificar projeto Android
      working-directory: ./frontend
      run: |
        if [ ! -d "android" ]; then
          echo "üì± Criando projeto Android..."
          npx cap add android
        else
          echo "‚úÖ Projeto Android encontrado"
        fi
        # Verificar se dist existe
        if [ ! -d "dist" ]; then
          echo "‚ùå Pasta dist n√£o encontrada. Build pode ter falhado."
          exit 1
        fi
    
    - name: Sincronizar Capacitor
      working-directory: ./frontend
      run: |
        echo "üîÑ Sincronizando Capacitor..."
        # Verificar se Capacitor est√° instalado
        if ! command -v npx &> /dev/null; then
          echo "‚ùå npx n√£o encontrado"
          exit 1
        fi
        # Sincronizar com output detalhado
        npx cap sync android --verbose || {
          echo "‚ùå Erro ao sincronizar Capacitor"
          echo "üìã Debug info:"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Capacitor version: $(npx cap --version 2>/dev/null || echo 'n√£o encontrado')"
          echo "Estrutura atual:"
          ls -la
          if [ -d "android" ]; then
            echo "Pasta android existe"
            ls -la android/ | head -10
          else
            echo "Pasta android N√ÉO existe"
          fi
          exit 1
        }
    
    - name: Gerar APK Debug
      working-directory: ./frontend/android
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug --stacktrace || {
          echo "‚ùå Erro ao gerar APK"
          echo "üìã Verificando estrutura..."
          ls -la app/ 2>/dev/null || echo "Pasta app n√£o existe"
          exit 1
        }
    
    - name: Upload APK como artefato
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: frontend/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
    
    - name: Criar Release (apenas em push para main/master)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        files: frontend/android/app/build/outputs/apk/debug/app-debug.apk
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          APK gerado automaticamente via GitHub Actions
          
          **Como instalar:**
          1. Baixe o APK
          2. Transfira para seu dispositivo Android
          3. Permita instala√ß√£o de fontes desconhecidas
          4. Instale o app
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

